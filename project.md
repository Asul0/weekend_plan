# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã AI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: Weekend Plan Assistant

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
weekend_plan/
‚îú‚îÄ‚îÄ main.py                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ Telegram-–±–æ—Ç–∞
‚îú‚îÄ‚îÄ server.py                  # FastAPI –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è API –ê—Ñ–∏—à–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ gigachat_client.py    # –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API
‚îÇ   ‚îú‚îÄ‚îÄ agent_core/           # –Ø–¥—Ä–æ AI-–∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graph.py          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π LangGraph
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodes.py          # –£–∑–ª—ã –≥—Ä–∞—Ñ–∞ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ state.py          # –°—Ö–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ planner.py        # –ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –ø–ª–∞–Ω–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ command_processor.py # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schedule_parser.py # –ü–∞—Ä—Å–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ schemas/              # Pydantic —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data_schemas.py   # –í—Å–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ services/             # –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ afisha_service.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –ê—Ñ–∏—à–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gis_service.py    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 2–ì–ò–° API
‚îÇ   ‚îú‚îÄ‚îÄ tools/                # LangChain –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ datetime_parser_tool.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event_search_tool.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gis_tools.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route_builder_tool.py
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ callbacks.py      # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–ª–ª–±—ç–∫–æ–≤
‚îî‚îÄ‚îÄ test/                     # –¢–µ—Å—Ç—ã (15 —Ñ–∞–π–ª–æ–≤)
    ‚îú‚îÄ‚îÄ test_full_scenario.py # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    ‚îî‚îÄ‚îÄ test_*.py             # Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞:**

- **Layer-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏ (–∞–≥–µ–Ω—Ç, —Å–µ—Ä–≤–∏—Å—ã, —Å—Ö–µ–º—ã)
- **Domain-driven –ø–æ–¥—Ö–æ–¥** —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –¥–æ–º–µ–Ω–æ–≤ (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–∏—Å–∫, –º–∞—Ä—à—Ä—É—Ç—ã)
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è              | –í–µ—Ä—Å–∏—è/–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ                                               |
| ----------------------- | ----------------- | ------------------------------------------------------ |
| **Python**              | 3.13+             | –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è                         |
| **LangGraph**           | Latest            | –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è AI-–∞–≥–µ–Ω—Ç–æ–≤ —Å –≥—Ä–∞—Ñ–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π |
| **LangChain**           | Latest            | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏                       |
| **GigaChat**            | API               | –†–æ—Å—Å–∏–π—Å–∫–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤      |
| **Pydantic**            | v2                | –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö                        |
| **FastAPI**             | Latest            | –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è API –ê—Ñ–∏—à–∏                            |
| **aiohttp**             | Latest            | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã                               |
| **python-telegram-bot** | Latest            | Telegram Bot API                                       |
| **2–ì–ò–° API**            | v3.0              | –ü–æ–∏—Å–∫ –º–µ—Å—Ç –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤                      |
| **–ê—Ñ–∏—à–∞.—Ä—É API**        | v3                | –ü–æ–∏—Å–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π                                      |

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª requirements.txt –∏–ª–∏ pyproject.toml, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º –ø—Ä–æ–µ–∫—Ç–∞.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

**1. –ì—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π (StateGraph)**

```python
# src/agent_core/graph.py
workflow = StateGraph(AgentState)
workflow.set_conditional_entry_point(
    should_classify_or_process_address,
    {
        "PROCESS_START_ADDRESS": "PROCESS_START_ADDRESS",
        "classify_intent": "classify_intent",
    },
)
```

**2. –£–∑–ª—ã-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (Nodes)**

```python
# src/agent_core/nodes.py
async def classify_intent_node(state: AgentState) -> AgentState:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    llm = get_gigachat_client()
    structured_llm = llm.with_structured_output(ClassifiedIntent)
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

**3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º**

```python
# src/agent_core/state.py
class AgentState(TypedDict):
    user_message: str
    chat_history: Annotated[List[BaseMessage], add]
    classified_intent: Optional[ClassifiedIntent]
    search_criteria: Optional[ExtractedInitialInfo]
    current_plan: Optional[Plan]
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
```

**4. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã**

```python
def decide_after_classification(state: AgentState) -> str:
    if state.get("classified_intent").intent == UserIntent.CHITCHAT:
        return "CLARIFY_OR_CHITCHAT"
    return "router"
```

**5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry**

```python
# src/services/afisha_service.py
try:
    async with session.get(url, params=params, timeout=aiohttp.ClientTimeout(total=60)) as response:
        # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
except aiohttp.ClientConnectorError as e:
    logger.error(f"Afisha Proxy ClientConnectorError: {e}")
```

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å LLM (GigaChat)

**–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤:**

```python
# src/agent_core/nodes.py
prompt = f"""
–¢—ã ‚Äî –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–∏ —á–µ—Ç–∫–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ –û–î–ù–û–ô –∏–∑ —Ç—Ä–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ö–ª—é—á–µ–≤—ã–µ –ü—Ä–∏–∑–Ω–∞–∫–∏:
1. **PLAN_REQUEST**: –í –∑–∞–ø—Ä–æ—Å–µ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ê–ö–¢–ò–í–ù–û–°–¢–ï–ô, –ú–ï–°–¢–ê –∏–ª–∏ –í–†–ï–ú–ï–ù–ò
2. **FEEDBACK_ON_PLAN**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞–Ω
3. **CHITCHAT**: –û–±—â–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –≤–æ–ø—Ä–æ—Å –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö

**–ó–∞–ø—Ä–æ—Å:** "{user_query}"
"""
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤:**

```python
structured_llm = llm.with_structured_output(ClassifiedIntent)
result = await structured_llm.ainvoke(prompt, config={"callbacks": [token_callback]})
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

**2–ì–ò–° API:**

```python
# src/services/gis_service.py
async def search_parks(original_query: str, city: Optional[str] = None) -> List[ParkInfo]:
    params = {
        "q": api_q,
        "type": relevant_types_str,
        "fields": "items.id,items.name,items.full_name,items.address_name,items.geometry.centroid",
        "key": GIS_API_KEY,
    }
```

**–ê—Ñ–∏—à–∞.—Ä—É API (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏):**

```python
# src/services/afisha_service.py
async def _make_afisha_request(session: aiohttp.ClientSession, endpoint: str) -> Optional[Dict]:
    full_url = f"{settings.AFISHA_PROXY_BASE_URL.rstrip('/')}/{endpoint.lstrip('/')}"
    headers_to_afisha["X-ApiAuth-PartnerKey"] = PROXY_INTERNAL_PARTNER_KEY
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**Pydantic —Å—Ö–µ–º—ã:**

```python
# src/schemas/data_schemas.py
class Event(BaseModel):
    session_id: int = Field(description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ–∞–Ω—Å–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    name: str = Field(description="–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    start_time_iso: str = Field(description="–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO")
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

    model_config = ConfigDict(extra="ignore", arbitrary_types_allowed=True)
```

## ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **–¢–∏–ø–∏–∑–∞—Ü–∏—è:** –ê–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ type hints –∏ Pydantic –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å aiohttp
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–∫—Ä—ã—Ç–∏–µ unit –∏ integration —Ç–µ—Å—Ç–∞–º–∏
5. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–∞–π–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** (requirements.txt/pyproject.toml)
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —É–∑–ª–∞—Ö
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏** –≤ —Ñ–æ—Ä–º–∞—Ç–µ docstring
4. **–•–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π** –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤:**

- 15 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
- Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –≥—Ä–∞—Ñ–∞
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö API

```python
# test/test_full_scenario.py
class TestFullScenario(unittest.IsolatedAsyncioTestCase):
    @patch("src.agent_core.nodes.fetch_cities", new_callable=AsyncMock)
    @patch("src.agent_core.nodes.datetime_parser_tool", new_callable=AsyncMock)
    async def test_scenario_plan_refine_address(self, mock_fetch_cities, mock_datetime_parser):
        # ... —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
```

## ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ —É–∑–ª—ã –∏ –≥—Ä–∞—Ñ—ã

### 1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π (classify_intent_node)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–ª–∞–Ω, —Ñ–∏–¥–±–µ–∫, –æ–±—â–µ–Ω–∏–µ)

```python
async def classify_intent_node(state: AgentState) -> AgentState:
    llm = get_gigachat_client()
    structured_llm = llm.with_structured_output(ClassifiedIntent)

    prompt = f"""
    –¢—ã ‚Äî –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä.
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å: "{user_query}"
    """

    result = await structured_llm.ainvoke(prompt)
    state["classified_intent"] = result
    return state
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `user_message`, `chat_history`
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `ClassifiedIntent` —Å —Ç–∏–ø–æ–º –Ω–∞–º–µ—Ä–µ–Ω–∏—è

### 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ (extract_initial_criteria_node)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

```python
async def extract_initial_criteria_node(state: AgentState) -> AgentState:
    # –≠—Ç–∞–ø 1: –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
    simple_extractor = llm.with_structured_output(SimplifiedExtractedInfo)
    simplified_data = await simple_extractor.ainvoke(prompt_extract)

    # –≠—Ç–∞–ø 2: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
    for activity_str in activities_list:
        classified_activity = await activity_classifier.ainvoke(prompt_classify)
        ordered_activities.append(OrderedActivityItem(
            activity_type=classified_activity.activity_type,
            query_details=activity_str,
        ))
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `user_message`
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `ExtractedInitialInfo` —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –ø–æ–∏—Å–∫–∞

### 3. –ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –ø–ª–∞–Ω–æ–≤ (PlanBuilder)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤

```python
class PlanBuilder:
    async def _find_best_plan_for_activities(self, activities_to_plan: List[OrderedActivityItem]):
        # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        for combination in itertools.product(*activity_slots):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            for item_to_add in combination:
                check_result = await self._check_compatibility(last_item_state, item_to_add)
                if check_result["compatible"]:
                    # –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –ø–ª–∞–Ω
                    current_plan_items.append(activity_dict)
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `cached_candidates`, `search_criteria`
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `Plan` —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–æ–º

### 4. –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ñ–∏–¥–±–µ–∫–∞ (analyze_feedback_node)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞

```python
async def analyze_feedback_node(state: AgentState) -> AgentState:
    # Chain of Thought –ø–æ–¥—Ö–æ–¥
    prompt = f"""
    <reasoning>
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ä–∞–∑–∏–ª —á–µ—Ç—ã—Ä–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è...
    </reasoning>
    <commands>
    modify;MOVIE;start_time;LESS_THAN;None;1 —á–∞—Å
    delete;PARK;None;None;None;None
    </commands>
    """

    # –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥
    command_text_match = re.search(r"<commands>(.*?)</commands>", response_text, re.DOTALL)
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `user_message`, `current_plan`
**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `command_queue` —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 5. –ü—Ä–µ–∑–µ–Ω—Ç–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (presenter_node)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```python
async def presenter_node(state: AgentState) -> AgentState:
    if not user_start_address:
        # –ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
        state["is_awaiting_start_address"] = True
        response_text = await llm.ainvoke(prompt)
    else:
        # –ü–æ–∫–∞–∑ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º
        response_text = await llm.ainvoke(prompt_with_route)

    state["chat_history"].append(AIMessage(content=response_text))
    return state
```

## üìã –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: **Middle-Senior**

–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ AI-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** LangGraph + LangChain –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è AI-–∞–≥–µ–Ω—Ç–æ–≤
2. **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è:** Pydantic v2 —Å –ø–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤
4. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:** –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

1. **–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** (requirements.txt –∏–ª–∏ pyproject.toml)
2. **–£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** - –¥–æ–±–∞–≤–∏—Ç—å docstrings –≤ —Ñ–æ—Ä–º–∞—Ç–µ Google/NumPy
3. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –≤—ã–Ω–µ—Å—Ç–∏ –æ–±—â—É—é –ª–æ–≥–∏–∫—É –≤ —É—Ç–∏–ª–∏—Ç—ã
4. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** - –≤—ã–Ω–µ—Å—Ç–∏ —Ö–∞—Ä–¥–∫–æ–¥ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
5. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
6. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–∞–∑–≤–∏—Ç–∏—è

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç –æ—Ç–ª–∏—á–Ω—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:

- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ API
- –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 8.5/10 - –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ —Ö–æ—Ä–æ—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
